const userPrefsStore={prefix:"marl_",save(e,t){marlConsole(`Saving user preference <b>(${e}: ${t})</b>`,"info"),localStorage.setItem(this.prefix+e,t)},load(e){const t=localStorage.getItem(this.prefix+e);(null!==t||"lang"===e)&&this.set(e,t)},set(e,t){switch(e){case"sortAsc":(t=1==+t)!==Alpine.store("files").sortAsc&&(Alpine.store("files").sortAsc=t);break;case"pageSize":"number"==typeof(t=+t)&&!isNaN(t)&&t>0&&t!==Alpine.store("files").pageSize&&(Alpine.store("files").pageSize=t);break;case"lang":if(t||(t=detectLangFromBrowser())&&this.save("lang",t),!t||!Alpine.store("ui").appLangs[t]){if(t){const e=`<b>Unrecognized language</b> in user preferences: ${t}`;console.warn(e),marlConsole(e,"warn")}t="en",this.save("lang",t)}Alpine.store("ui").lang=t;break;case"theme":"dark"!==t&&"light"!==t&&(t="light",this.save("theme",t)),Alpine.store("ui").theme=t,setTheme(t)}}},filesStore={resetState(){this.loadingQueue=[],this.currentlyLoading={},this.currentlyLoadingId="",this.currentlyLoadingName="",this.serverMode=!1,this.remotes=[],this.marlBasePath="",this.sources=[],this.toots=[],this.toc=[],this.duplicates=!1,this.sortAsc=!0,this.pageSize=10,this.currentPage=1,this.loading=!1,this.loadingFailed=!1,this.languages={},this.boostsAuthors=[],this.filters={},this.filtersDefault={fullText:"",hashtagText:"",mentionText:"",externalLink:"",summary:"",isEdited:!1,isDuplicate:!1,noStartingAt:!1,hasExternalLink:!1,hasHashtags:!1,hasMentions:!1,hasSummary:!1,isSensitive:!1,visibilityPublic:!0,visibilityUnlisted:!0,visibilityFollowers:!0,visibilityMentioned:!0,typeOriginal:!0,typeBoost:!0,attachmentAny:!1,attachmentImage:!1,attachmentVideo:!1,attachmentSound:!1,attachmentNoAltText:!1,attachmentWithAltText:!1},this.filtersActive=!1,this.tagsFilters={hashtags:"",mentions:"",boostsAuthors:""},Alpine.store("userPrefs").load("sortAsc"),Alpine.store("userPrefs").load("pageSize")},setFilter(){this.checkPagingValue(),scrollTootsToTop(),pagingUpdated(),JSON.stringify(this.filters)===JSON.stringify(this.filtersDefault)?this.filtersActive=!1:this.filtersActive=!0;const e=this;setTimeout((()=>{e.checkPagingValue()}),50)},filterByTag(e,t,s){t&&(t===this.filters[e]?this.filters[e]="":this.filters[e]=t),"fullText"==e&&(""===this.filters[e]?(this.filters.typeBoost=!0,this.filters.typeOriginal=!0):(this.filters.typeBoost=!0,this.filters.typeOriginal=!1)),this.setFilter(),setTimeout((()=>{document.getElementById(s).focus()}),100)},resetFilters(e){this.filters=JSON.parse(JSON.stringify(this.filtersDefault)),e&&(this.currentPage=1,this.filtersActive=!1,scrollTootsToTop(),pagingUpdated())},get filteredToots(){const e=this.filters,t=this.filtersActive;return this.toots.filter((s=>{if(!t)return!0;if(e.fullText){let t=!1;const i=e.fullText.toLowerCase();if(s._marl.textContent&&s._marl.textContent&&s._marl.textContent.indexOf(i)>=0&&(t=!0),s._marl.hasAttachments&&s.object.attachment.forEach((e=>{const s=e.name;s&&s.indexOf(i)>=0&&(t=!0)})),!t)return t}if(e.hashtagText){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;{const t=e.hashtagText.toLowerCase();if(!s.object.tag.some((e=>"Hashtag"===e.type&&e.name.toLowerCase().indexOf(t)>-1)))return!1}}if(e.mentionText){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;{const t=e.mentionText.toLowerCase();if(!s.object.tag.some((e=>"Mention"===e.type&&e.name.toLowerCase().indexOf(t)>-1)))return!1}}if(e.summary){if(!s._marl.summary)return!1;{const t=e.summary.toLowerCase();if(-1===s._marl.summary.indexOf(t))return!1}}if(e.isEdited&&("object"!=typeof s.object||null===s.object||!s.object.updated))return!1;if(e.isDuplicate&&!s._marl.duplicate)return!1;if(e.noStartingAt&&(!s._marl.textContent||0===s._marl.textContent.indexOf("@")))return!1;if(e.hasExternalLink&&(!s._marl.externalLinks||!s._marl.externalLinks.length))return!1;if(e.hasHashtags){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;if(!s.object.tag.some((e=>"Hashtag"===e.type)))return!1}if(e.hasMentions){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;if(!s.object.tag.some((e=>"Mention"===e.type)))return!1}if(e.hasSummary){if("object"!=typeof s.object||null===s.object)return!1;if(!s.object.summary)return!1}if(e.isSensitive){if("object"!=typeof s.object||null===s.object)return!1;if(!s.object.sensitive)return!1}if(e.externalLink){let t=!1;if(s._marl.externalLinks&&s._marl.externalLinks.length){const i=e.externalLink.toLowerCase();t=s._marl.externalLinks.some((e=>e.href.indexOf(i)>-1||e.text.indexOf(i)>-1))}if(!t)return!1}if(!e.visibilityPublic&&"public"===s._marl.visibility[0])return!1;if(!e.visibilityUnlisted&&"unlisted"===s._marl.visibility[0])return!1;if(!e.visibilityFollowers&&"followers"===s._marl.visibility[0])return!1;if(!e.visibilityMentioned&&"mentioned"===s._marl.visibility[0])return!1;if(!e.typeOriginal&&"Create"===s.type)return!1;if(!e.typeBoost&&"Announce"===s.type)return!1;if(e.attachmentAny&&!s._marl.hasAttachments)return!1;if(e.attachmentImage){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsImage(e))))return!1}if(e.attachmentVideo){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsVideo(e))))return!1}if(e.attachmentSound){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsSound(e))))return!1}if(e.attachmentNoAltText){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>null===e.name)))return!1}if(e.attachmentWithAltText){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>e.name)))return!1}for(const t in this.languages)if(e.hasOwnProperty("lang_"+t)&&!1===e["lang_"+t]&&(s._marl.langs.includes(t)||0===s._marl.langs.length))return!1;for(const t of this.sources){const i=t.id;if(e.hasOwnProperty("actor_"+i)&&!1===e["actor_"+i]&&s._marl.source===i)return!1}return!0}))},get listHashtags(){return this.listTags("Hashtag")},get listMentions(){return this.listTags("Mention")},listTags(e){let t="";switch(e){case"Mention":t="mentions";break;case"Hashtag":t="hashtags"}let s=this.filteredToots.reduce(((s,i)=>{if(tootHasTags(i))for(const n in i.object.tag){const o=i.object.tag[n];o.type&&o.type===e&&o.name&&o.name.toLowerCase().indexOf(this.tagsFilters[t].toLowerCase())>=0&&(s.some((e=>e.name===o.name))?s.map((e=>{e.name===o.name&&e.nb++})):s.push({name:o.name,href:o.href,nb:1}))}return s}),[]);return s.sort(((e,t)=>e.nb===t.nb?e.name.localeCompare(t.name):t.nb-e.nb)),s},get listBoostsAuthors(){let e=this.boostsAuthors.reduce(((e,t)=>(t.name.toLowerCase().indexOf(this.tagsFilters.boostsAuthors.toLowerCase())>=0&&e.push(t),e)),[]);return e.sort(((e,t)=>{if(e.nb===t.nb){let s=0===e.name.indexOf("? "),i=0===t.name.indexOf("? ");return s&&i?e.name.localeCompare(t.name):s?1:i?-1:e.name.localeCompare(t.name)}return e.nb===t.nb?e.name.localeCompare(t.name):t.nb-e.nb})),e},get sortedLanguages(){let e=[];for(const t in this.languages)e.push([t,this.languages[t]]);return e.sort(((e,t)=>"undefined"===e[0]?1:"undefined"===t[0]?-1:e[1]===t[1]?e[0].localeCompare(t[0]):t[1]-e[1])),e},get appReady(){return!(this.loading||!this.sources.length)},get totalPages(){return Math.ceil(this.filteredToots.length/this.pageSize)},get pagedToots(){return this.filteredToots?this.filteredToots.filter(((e,t)=>{let s=(this.currentPage-1)*this.pageSize,i=this.currentPage*this.pageSize;if(t>=s&&t<i)return!0})):[]},sortToots(){this.toots.sort(((e,t)=>this.sortAsc?e.published.localeCompare(t.published):t.published.localeCompare(e.published)))},toggleTootsOrder(){this.sortAsc=!this.sortAsc,Alpine.store("userPrefs").save("sortAsc",this.sortAsc?1:0),this.sortToots(),scrollTootsToTop(),pagingUpdated()},setPostsPerPage(){this.checkPagingValue(),Alpine.store("userPrefs").save("pageSize",this.pageSize)},checkPagingValue(){this.currentPage<1?this.currentPage=1:this.currentPage>this.totalPages&&(this.currentPage=this.totalPages)},nextPage(e){this.currentPage*this.pageSize<this.filteredToots.length&&(this.currentPage++,scrollTootsToTop(e),pagingUpdated())},prevPage(e){this.currentPage>1&&(this.currentPage--,scrollTootsToTop(e),pagingUpdated())},firstPage(e){this.currentPage=1,scrollTootsToTop(e),pagingUpdated()},lastPage(e){this.currentPage=this.totalPages,scrollTootsToTop(e),pagingUpdated()}},lightboxStore={resetState(){this.show=!1,this.data=[],this.source=0,this.index=0,this.origin=""},open(e,t,s){this.data=e.object.attachment,this.source=e._marl.source,this.show=!0,this.index=t,this.origin=s,document.getElementById("main-section-inner").setAttribute("inert",!0),setTimeout((()=>{document.getElementById("lightbox").focus()}),50)},openProfileImg(e,t,s){let i="";localMode()&&(i=Alpine.store("files").sources[s][e].type);const n={object:{attachment:[{name:e,url:e,mediaType:i}]},_marl:{source:s}};this.open(n,0,t)},close(){const e=this.origin;this.data=[],this.index=0,this.show=!1,this.origin="",document.getElementById("main-section-inner").removeAttribute("inert"),document.getElementById(e).focus()},showNext(){this.index++,this.index>=this.data.length&&(this.index=0),attachmentIsImage(this.data[this.index])||this.showNext()},showPrev(){this.index--,this.index<0&&(this.index=this.data.length-1),attachmentIsImage(this.data[this.index])||this.showPrev()}},uiStore={log:[],resetState(){this.pagingOptionsVisible=!1,this.openMenu="",this.actorPanel=0,this.menuIsActive=!1,this.lang="en",this.appLangs=appLangs??{en:"English"},this.theme="light",this.errorInLog=!1,this.log=this.log??[],Alpine.store("userPrefs").load("lang"),Alpine.store("userPrefs").load("theme")},logMsg(e,t){let s={msg:e,type:t=t??"info",time:(new Date).toLocaleTimeString(Alpine.store("ui").lang,{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})};this.log.unshift(s),"error"===t&&(this.errorInLog=!0)},toggleTheme(){this.theme="light"===this.theme?"dark":"light",Alpine.store("userPrefs").save("theme",this.theme),setTheme(this.theme)},togglePagingOptions(){this.pagingOptionsVisible=!this.pagingOptionsVisible,this.pagingOptionsVisible&&setTimeout((()=>{document.getElementById("paging-options").focus()}),100)},get pagingOptionsClass(){return this.pagingOptionsVisible?"open":""},openActorPanel(e){this.actorPanel=e,setTimeout((()=>{document.getElementById("actorpanel-"+e).scrollTop=0}),50)},switchActorPanel(e){let t=this.actorPanel;"up"===e?(t++,t>=Alpine.store("files").sources.length&&(t=0)):(t--,t<0&&(t=Alpine.store("files").sources.length-1)),this.actorPanel=t,document.getElementById("actortab-"+t).focus()},menuClose(){const e=this.openMenu;this.openMenu="",this.setInert(),"tools"!==e||this.menuIsActive?document.querySelector("#main-section-inner .mobile-menu .menu-"+e).focus():document.getElementById("header-open-tools").focus()},menuOpen(e){this.openMenu=e,this.resetPanels(),this.setInert(),setTimeout((()=>{document.getElementById("panel-"+e).focus()}),100)},menuToggle(e){switch(e){case"actor":case"filters":case"tags":case"tools":this.openMenu===e?this.menuClose():this.menuOpen(e)}},resetPanels(){const e=this.openMenu;if(document.querySelectorAll(`#panel-${e} details[open]`).forEach((e=>{e.removeAttribute("open")})),"actor"===e){const e="actorpanel-"+this.actorPanel;setTimeout((()=>{document.getElementById(e).scrollTop=0}),250)}else setTimeout((()=>{document.getElementById("panel-"+e).scrollTop=0}),250)},checkMenuState(){const e=document.getElementById("mobile-menu");"none"===window.getComputedStyle(e,null).display?this.menuIsActive=!1:this.menuIsActive=!0,this.setInert()},setInertMain(){document.querySelectorAll("#main-section-inner > *:not(.mobile-menu, .panel-backdrop, #panel-"+this.openMenu).forEach((e=>{e.setAttribute("inert",!0)}))},setInertPanels(){document.querySelectorAll("#panel-actor, #panel-filters, #panel-tags, #panel-tools").forEach((e=>{e.setAttribute("inert",!0)}))},setInertTools(){document.querySelectorAll("#panel-tools").forEach((e=>{e.setAttribute("inert",!0)}))},setInert(){document.querySelectorAll("#main-section-inner > *").forEach((e=>{e.removeAttribute("inert")})),this.menuIsActive?this.openMenu?this.setInertMain():this.setInertPanels():"tools"===this.openMenu?this.setInertMain():this.setInertTools()},get appClasses(){let e=[];return this.openMenu?e.push("menu-open menu-open-"+this.openMenu):e.push("menu-closed"),e}};