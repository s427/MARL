const userPrefsStore={prefix:"marl_",save(e,t){if(!0===t&&(t=1),!1===t&&(t=0),localStorage.setItem(this.prefix+e,t),"activePanel"!==e){marlConsole(`Saving user preference <b>(${e}: ${t})</b>`,"info")}},load(e){const t=localStorage.getItem(this.prefix+e);if(null!==t)this.set(e,t);else switch(e){case"lang":case"theme":this.set(e,t)}},set(e,t){switch(e){case"sortAsc":case"combinePanels":case"simplifyPostsDisplay":(t=1==+t)!==Alpine.store("ui")[e]&&(Alpine.store("ui")[e]=t);break;case"pageSize":"number"==typeof(t=+t)&&!isNaN(t)&&t>0&&t!==Alpine.store("ui")[e]&&(Alpine.store("ui")[e]=t);break;case"activePanel":t&&combinedPanelsMode()&&(Alpine.store("ui")[e]=t);break;case"defaultPanel":t&&(Alpine.store("ui")[e]=t);break;case"lang":if(t||(t=detectLangFromBrowser())&&this.save("lang",t),!t||!Alpine.store("ui").appLangs[t]){if(t){const e=`<b>Unrecognized language</b> in user preferences: ${t}`;console.warn(e),marlConsole(e,"warn")}t="en",this.save("lang",t)}Alpine.store("ui")[e]=t;break;case"theme":t||(t=detectThemePreference()),validTheme(t)||(t=customPrefAvailable("theme")&&validTheme(customPrefs.theme)?customPrefs.theme:detectThemePreference(),this.save("theme",t)),Alpine.store("ui")[e]=t}}},filesStore={resetState(){this.loadingQueue=[],this.currentlyLoading={},this.currentlyLoadingId="",this.currentlyLoadingName="",this.remotes=[],this.marlBasePath="",this.sources=[],this.toots=[],this.toc=[],this.currentPage=1,this.loading=!1,this.loadingFailed=!1,this.languages={},this.boostsAuthors=[],this.conversation=[],this.conversationSource=null,this.date={first:null,last:null},this.filters={},this.filtersDefault={fullText:"",hashtagText:"",mentionText:"",externalLink:"",summary:"",isDuplicate:!1,hasExternalLink:!1,hasHashtags:!1,hasMentions:!1,hasPoll:!1,hasSummary:!1,startingAt:!1,noStartingAt:!1,isSensitive:!1,isEdited:!1,isInConversation:!1,hasLikes:"0",hasShares:"0",afterDate:"",beforeDate:"",afterTime:"",beforeTime:"",typeOriginal:!0,typeBoost:!0,attachmentAny:!1,attachmentImage:!1,attachmentVideo:!1,attachmentSound:!1,attachmentNoAltText:!1,attachmentWithAltText:!1,visibilityPublic:!0,visibilityUnlisted:!0,visibilityFollowers:!0,visibilityMentioned:!0},this.filtersActive=!1,this.activeFilters={isEdited:!1,isDuplicate:!1,hasExternalLink:!1,hasPoll:!1,hasSummary:!1,isSensitive:!1,isInConversation:!1,hasLikes:!1,hasShares:!1,typeOriginal:!1,typeBoost:!1,attachmentAny:!1,attachmentImage:!1,attachmentVideo:!1,attachmentSound:!1,attachmentNoAltText:!1,attachmentWithAltText:!1,visibilityPublic:!1,visibilityUnlisted:!1,visibilityFollowers:!1,visibilityMentioned:!1},this.tagsFilters={hashtags:"",mentions:"",boostsAuthors:""}},serverMode:!1,setFilter(e){this.checkPagingValue(),scrollTootsToTop(),pagingUpdated(),this.checkFiltersActive(),this.filters.startingAt&&this.filters.noStartingAt&&("startingAt"===e&&(this.filters.noStartingAt=!1),"noStartingAt"===e&&(this.filters.startingAt=!1));const t=this;setTimeout((()=>{t.checkPagingValue()}),50)},checkFiltersActive(){JSON.stringify(this.filters)===JSON.stringify(this.filtersDefault)?this.filtersActive=!1:this.filtersActive=!0},filterByTag(e,t,s){t&&(t===this.filters[e]?this.filters[e]="":this.filters[e]=t),"fullText"==e&&(""===this.filters[e]?(this.filters.typeBoost=!0,this.filters.typeOriginal=!0):(this.filters.typeBoost=!0,this.filters.typeOriginal=!1)),this.setFilter(),setTimeout((()=>{document.getElementById(s).focus()}),100)},resetFilters(e){this.filters=JSON.parse(JSON.stringify(this.filtersDefault)),e&&(this.currentPage=1,this.checkFiltersActive(),scrollTootsToTop(),pagingUpdated())},get filteredToots(){const e=this.filters,t=this.filtersActive;return this.toots.filter((s=>{if(!t)return!0;if(e.fullText){let t=!1;const i=e.fullText.toLowerCase();if(s._marl.textContent&&s._marl.textContent&&s._marl.textContent.indexOf(i)>=0&&(t=!0),s.id.indexOf(i)>=0&&(t=!0),"object"==typeof s.object&&null!==s.object&&s.object.inReplyTo&&s.object.inReplyTo.indexOf(i)>=0&&(t=!0),s._marl.hasAttachments&&s.object.attachment.forEach((e=>{const s=e.name;s&&s.indexOf(i)>=0&&(t=!0)})),s._marl.summary&&s._marl.summary.indexOf(i)>=0&&(t=!0),s._marl.pollType){s.object[s._marl.pollType].filter((e=>e.name.toLowerCase().indexOf(i)>=0)).length&&(t=!0)}if(!t)return t}if(e.hashtagText){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;{const t=e.hashtagText.toLowerCase();if(!s.object.tag.some((e=>"Hashtag"===e.type&&e.name.toLowerCase().indexOf(t)>-1)))return!1}}if(e.mentionText){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;{const t=e.mentionText.toLowerCase();if(!s.object.tag.some((e=>"Mention"===e.type&&e.name.toLowerCase().indexOf(t)>-1)))return!1}}if(e.summary){if(!s._marl.summary)return!1;{const t=e.summary.toLowerCase();if(-1===s._marl.summary.indexOf(t))return!1}}if(e.externalLink){let t=!1;if(s._marl.externalLinks&&s._marl.externalLinks.length){const i=e.externalLink.toLowerCase();t=s._marl.externalLinks.some((e=>e.href.indexOf(i)>-1||e.text.indexOf(i)>-1))}if(!t)return!1}if(e.isDuplicate&&!s._marl.duplicate)return!1;if(e.hasHashtags){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;if(!s.object.tag.some((e=>"Hashtag"===e.type)))return!1}if(e.hasMentions){if("object"!=typeof s.object||null===s.object||!s.object.tag)return!1;if(!s.object.tag.some((e=>"Mention"===e.type)))return!1}if(e.hasPoll){if("object"!=typeof s.object||null===s.object||!s.object.type)return!1;if("Question"!==s.object.type)return!1}if(e.hasSummary){if("object"!=typeof s.object||null===s.object)return!1;if(!s.object.summary)return!1}if(e.hasExternalLink&&(!s._marl.externalLinks||!s._marl.externalLinks.length))return!1;if(e.startingAt&&(!s._marl.textContent||0!==s._marl.textContent.indexOf("@")))return!1;if(e.noStartingAt&&s._marl.textContent&&0===s._marl.textContent.indexOf("@"))return!1;if(e.isSensitive){if("object"!=typeof s.object||null===s.object)return!1;if(!s.object.sensitive)return!1}if(e.isEdited&&("object"!=typeof s.object||null===s.object||!s.object.updated))return!1;if(e.isInConversation&&!s._marl.replies.length&&!s._marl.inReplyTo)return!1;if(e.hasLikes&&e.hasLikes>0){if("object"!=typeof s.object||null===s.object||!s.object.likes)return!1;if(s.object.likes.totalItems<e.hasLikes)return!1}if(e.hasShares&&e.hasShares>0){if("object"!=typeof s.object||null===s.object||!s.object.shares)return!1;if(s.object.shares.totalItems<e.hasShares)return!1}if(e.afterDate){const t=e.afterDate.replace(/-/g,"");if(s._marl.date<+t)return!1}if(e.beforeDate){const t=e.beforeDate.replace(/-/g,"");if(s._marl.date>+t)return!1}if(e.afterTime){const t=e.afterTime.replace(":","");if(s._marl.time<+t)return!1}if(e.beforeTime){const t=e.beforeTime.replace(":","");if(s._marl.time>+t)return!1}if(!e.typeOriginal&&"Create"===s.type)return!1;if(!e.typeBoost&&"Announce"===s.type)return!1;if(e.attachmentAny&&!s._marl.hasAttachments)return!1;if(e.attachmentImage){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsImage(e))))return!1}if(e.attachmentVideo){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsVideo(e))))return!1}if(e.attachmentSound){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>attachmentIsSound(e))))return!1}if(e.attachmentNoAltText){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>null===e.name)))return!1}if(e.attachmentWithAltText){if(!s._marl.hasAttachments)return!1;if(!s.object.attachment.some((e=>e.name)))return!1}if(!e.visibilityPublic&&"public"===s._marl.visibility[0])return!1;if(!e.visibilityUnlisted&&"unlisted"===s._marl.visibility[0])return!1;if(!e.visibilityFollowers&&"followers"===s._marl.visibility[0])return!1;if(!e.visibilityMentioned&&"mentioned"===s._marl.visibility[0])return!1;for(const t in this.languages)if(e.hasOwnProperty("lang_"+t)&&!1===e["lang_"+t]&&(s._marl.langs.includes(t)||0===s._marl.langs.length))return!1;for(const t of this.sources){const i=t.id;if(e.hasOwnProperty("actor_"+i)&&!1===e["actor_"+i]&&s._marl.source===i)return!1}return!0}))},get listHashtags(){return this.listTags("Hashtag")},get listMentions(){return this.listTags("Mention")},listTags(e){let t="",s="";switch(e){case"Mention":t="mentions",s="mentionText";break;case"Hashtag":t="hashtags",s="hashtagText"}let i=this.filteredToots.reduce(((i,n)=>{if(tootHasTags(n))for(const a in n.object.tag){const o=n.object.tag[a];o.type&&o.type===e&&o.name&&o.name.toLowerCase().indexOf(this.tagsFilters[t].toLowerCase())>=0&&(i.some((e=>e.name===o.name))?i.map((e=>{e.name===o.name&&e.nb++})):i.push({name:o.name,href:o.href,nb:1,active:Alpine.store("files").filters[s]===o.name}))}return i}),[]);return i.sort(((e,t)=>e.nb===t.nb?e.name.localeCompare(t.name):t.nb-e.nb)),i},get listBoostsAuthors(){let e=this.boostsAuthors.reduce(((e,t)=>(t.name.toLowerCase().indexOf(this.tagsFilters.boostsAuthors.toLowerCase())>=0&&(t.active=t.url===Alpine.store("files").filters.fullText.toLowerCase(),e.push(t)),e)),[]);return e.sort(((e,t)=>{if(e.nb===t.nb){let s=0===e.name.indexOf("? "),i=0===t.name.indexOf("? ");return s&&i?e.name.localeCompare(t.name):s?1:i?-1:e.name.localeCompare(t.name)}return e.nb===t.nb?e.name.localeCompare(t.name):t.nb-e.nb})),e},filteredLikesBookmarks(e,t){const s=this.sources[t][e].filter.toLowerCase(),i=this.sources[t][e].data;return i&&i.length?s?i.filter((e=>e.url.toLowerCase().indexOf(s)>=0)):i:[]},loadConversation(e){this.conversation=[],this.conversationSource="conversation-"+e._marl.id;const t=this.searchConversationStart(e);this.loadReplies(t),this.conversation.length&&setTimeout((()=>{this.focusConversation()}),10)},searchConversationStart(e){if("object"==typeof e.object&&null!==e.object&&e.object.inReplyTo){const t=this.getPostsById(e.object.inReplyTo);return t.length?this.searchConversationStart(t[0]):e}return e},loadReplies(e,t=0){e._marl.conversationLevel=t,this.conversation.push(e),e._marl.replies.length&&e._marl.replies.forEach((e=>{this.getPostsById(e).forEach((e=>{this.loadReplies(e,t),t++}))}))},getPostsById(e){return this.toots.filter((t=>0===t.id.indexOf(e)))},focusConversation(){const e=document.getElementById("panel-conversation");e&&(Alpine.store("ui").setInert(),e.focus())},closeConversation(){this.conversation=[],Alpine.store("ui").setInert();const e=document.getElementById(this.conversationSource);e&&e.focus(),this.conversationSource=null},get sortedLanguages(){let e=[];for(const t in this.languages)e.push([t,this.languages[t]]);return e.sort(((e,t)=>"undefined"===e[0]?1:"undefined"===t[0]?-1:e[1]===t[1]?e[0].localeCompare(t[0]):t[1]-e[1])),e},get appReady(){return!(this.loading||!this.sources.length)},get totalPages(){return Math.ceil(this.filteredToots.length/Alpine.store("ui").pageSize)},get pagedToots(){const e=Alpine.store("ui").pageSize;return this.filteredToots?this.filteredToots.filter(((t,s)=>{let i=(this.currentPage-1)*e,n=this.currentPage*e;if(s>=i&&s<n)return!0})):[]},sortToots(){const e=Alpine.store("ui").sortAsc;this.toots.sort(((t,s)=>e?t.published.localeCompare(s.published):s.published.localeCompare(t.published))),scrollTootsToTop(),pagingUpdated()},checkPagingValue(){this.currentPage<1?this.currentPage=1:this.currentPage>this.totalPages&&(this.currentPage=this.totalPages)},nextPage(e){this.currentPage*Alpine.store("ui").pageSize<this.filteredToots.length&&(this.currentPage++,scrollTootsToTop(e),pagingUpdated())},prevPage(e){this.currentPage>1&&(this.currentPage--,scrollTootsToTop(e),pagingUpdated())},firstPage(e){this.currentPage=1,scrollTootsToTop(e),pagingUpdated()},lastPage(e){this.currentPage=this.totalPages,scrollTootsToTop(e),pagingUpdated()}},lightboxStore={resetState(){this.show=!1,this.data=[],this.source=0,this.index=0,this.origin=""},open(e,t,s){this.data=e.object.attachment,this.source=e._marl.source,this.show=!0,this.index=t,this.origin=s,document.getElementById("main-section-inner").setAttribute("inert",!0),setTimeout((()=>{document.getElementById("lightbox").focus()}),50)},openProfileImg(e,t,s){let i="";localMode()&&(i=Alpine.store("files").sources[s][e].type);const n={object:{attachment:[{name:e,url:e,mediaType:i}]},_marl:{source:s}};this.open(n,0,t)},close(){const e=this.origin;this.resetState(),document.getElementById("main-section-inner").removeAttribute("inert"),document.getElementById(e).focus()},showNext(){this.index++,this.index>=this.data.length&&(this.index=0),attachmentIsImage(this.data[this.index])||this.showNext()},showPrev(){this.index--,this.index<0&&(this.index=this.data.length-1),attachmentIsImage(this.data[this.index])||this.showPrev()}},uiStore={log:[],defaultOptions:{lang:"en",theme:"light",sortAsc:!0,pageSize:10,combinePanels:!1,defaultPanel:"auto",simplifyPostsDisplay:!1},resetState(){this.pagingOptionsVisible=!1,this.actorPanel=0,this.mobileLayout=!1,this.appLangs=appLangs??{en:"English"},this.errorInLog=!1,this.log=this.log??[],this.activePanel="",this.postsScrolled=!1,this.lang=this.defaultOptions.lang,this.theme=this.defaultOptions.theme,this.sortAsc=this.defaultOptions.sortAsc,this.pageSize=this.defaultOptions.pageSize,this.combinePanels=this.defaultOptions.combinePanels,this.defaultPanel=this.defaultOptions.defaultPanel,this.simplifyPostsDisplay=this.defaultOptions.simplifyPostsDisplay,checkMobileLayout(),loadPref("lang"),loadPref("theme"),loadPref("sortAsc"),loadPref("pageSize"),loadPref("combinePanels"),loadPref("activePanel"),loadPref("defaultPanel"),loadPref("simplifyPostsDisplay"),setTheme(this.theme),combinedPanelsMode()&&("auto"===this.defaultPanel?this.panelOpen(this.activePanel?this.activePanel:"actor",!1):this.panelOpen(this.defaultPanel,!1))},changeDefault(e,t){switch(e){case"sortAsc":case"combinePanels":case"simplifyPostsDisplay":t=!!t;break;case"pageSize":if("number"!=typeof(t=+t)||isNaN(t)||0===t)return;break;case"defaultPanel":if(!validPanel(t))return;break;case"theme":if(!validTheme(t))return;setTheme(t);break;case"lang":if(!validLang(t))return;break;default:return}this.defaultOptions[e]=t},logMsg(e,t){let s={msg:e,type:t=t??"info",time:(new Date).toLocaleTimeString(Alpine.store("ui").lang,{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})};this.log.unshift(s),"error"===t&&(this.errorInLog=!0)},setOption(e){savePref(e,this[e]),"sortAsc"===e&&Alpine.store("files").sortToots(),"pageSize"===e&&Alpine.store("files").checkPagingValue(),"combinePanels"===e&&this.setInert()},toggleTheme(){this.theme="light"===this.theme?"dark":"light",savePref("theme",this.theme),setTheme(this.theme)},openActorTab(e){this.actorPanel=e,setTimeout((()=>{document.getElementById("actorpanel-"+e).scrollTop=0}),50)},switchActorTab(e){let t=this.actorPanel;"up"===e?(t++,t>=Alpine.store("files").sources.length&&(t=0)):(t--,t<0&&(t=Alpine.store("files").sources.length-1)),this.actorPanel=t,document.getElementById("actortab-"+t).focus()},panelClose(){if(combinedPanelsMode())return;const e=this.activePanel;this.activePanel="",this.setInert(),"tools"!==e||this.mobileLayout?document.querySelector("#main-section-inner .mobile-menu .menu-"+e).focus():document.getElementById("header-open-tools").focus()},panelOpen(e,t){this.activePanel=e,this.resetPanels(),this.setInert(),t&&setTimeout((()=>{document.getElementById("panel-"+e).focus()}),100)},panelToggle(e){switch(e){case"actor":case"filters":case"tags":case"tools":this.activePanel===e?combinedPanelsMode()||this.panelClose():(this.panelOpen(e,!0),savePref("activePanel",e))}},resetPanels(){const e=this.activePanel;if("auto"===e)return;document.querySelectorAll(`#panel-${e} details[open]`).forEach((e=>{e.removeAttribute("open")}));let t="panel-"+e;"actor"===e&&(t="actorpanel-"+this.actorPanel),setTimeout((()=>{const e=document.getElementById(t);e&&(e.scrollTop=0)}),250)},setInertMain(){const e=document.querySelectorAll("#main-section-inner > *:not(.mobile-menu, .panel-backdrop, #panel-"+this.activePanel);e.length&&e.forEach((e=>{e.setAttribute("inert",!0)}))},setInertPanels(){const e=document.querySelectorAll("#panel-actor, #panel-filters, #panel-tags, #panel-tools, #panel-conversation");if(e.length&&(e.forEach((e=>{e.setAttribute("inert",!0)})),combinedPanelsMode()&&this.activePanel)){const e=document.getElementById("panel-"+this.activePanel);e&&e.removeAttribute("inert")}},setInertTools(){const e=document.getElementById("panel-tools");e&&e.setAttribute("inert",!0)},setInert(){const e=document.querySelectorAll("#main-section-inner > *");if(e.length)if(Alpine.store("files").conversation.length)e.forEach((e=>{"panel-conversation"!==e.id&&e.setAttribute("inert",!0)}));else{{const e=document.getElementById("panel-conversation");e&&e.setAttribute("inert",!0)}e.forEach((e=>{e.removeAttribute("inert")})),combinedPanelsMode()?this.setInertPanels():this.mobileLayout?this.activePanel?this.setInertMain():this.setInertPanels():"tools"===this.activePanel?this.setInertMain():this.setInertTools()}},checkPostsScrolling(){const e=document.getElementById("toots");e&&(e.scrollTop>5?this.postsScrolled=!0:this.postsScrolled=!1)},get appClasses(){let e=[];return combinedPanelsMode()&&e.push("combine-panels"),this.simplifyPostsDisplay&&e.push("simplify-posts-display"),this.postsScrolled&&e.push("posts-scrolled"),e},get appInsideClasses(){let e=[];return this.activePanel?e.push("menu-open menu-open-"+this.activePanel):e.push("menu-closed"),e}};