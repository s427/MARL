const userPrefsStore={prefix:"marl_",save(t,e){!0===e&&(e=1),!1===e&&(e=0);marlConsole(`Saving user preference <b>(${t}: ${e})</b>`,"info"),localStorage.setItem(this.prefix+t,e)},load(t){const e=localStorage.getItem(this.prefix+t);(null!==e||"lang"===t)&&this.set(t,e)},set(t,e){switch(t){case"sortAsc":case"combinePanels":case"simplifyPostsDisplay":(e=1==+e)!==Alpine.store("ui")[t]&&(Alpine.store("ui")[t]=e),"combinePanels"===t&&e&&(Alpine.store("ui").activePanel=Alpine.store("ui").defaultPanel);break;case"pageSize":"number"==typeof(e=+e)&&!isNaN(e)&&e>0&&e!==Alpine.store("ui")[t]&&(Alpine.store("ui")[t]=e);break;case"activePanel":e&&Alpine.store("ui").combinePanels&&(Alpine.store("ui")[t]=e);break;case"defaultPanel":e&&(Alpine.store("ui")[t]=e,"auto"!==e&&Alpine.store("ui").combinePanels&&Alpine.store("ui").panelOpen(e,!1));break;case"lang":if(e||(e=detectLangFromBrowser())&&this.save("lang",e),!e||!Alpine.store("ui").appLangs[e]){if(e){const t=`<b>Unrecognized language</b> in user preferences: ${e}`;console.warn(t),marlConsole(t,"warn")}e="en",this.save("lang",e)}Alpine.store("ui")[t]=e;break;case"theme":"dark"!==e&&"light"!==e&&(e="light",this.save("theme",e)),Alpine.store("ui")[t]=e,setTheme(e)}}},filesStore={resetState(){this.loadingQueue=[],this.currentlyLoading={},this.currentlyLoadingId="",this.currentlyLoadingName="",this.serverMode=!1,this.remotes=[],this.marlBasePath="",this.sources=[],this.toots=[],this.toc=[],this.currentPage=1,this.loading=!1,this.loadingFailed=!1,this.languages={},this.boostsAuthors=[],this.filters={},this.filtersDefault={fullText:"",hashtagText:"",mentionText:"",externalLink:"",summary:"",isEdited:!1,isDuplicate:!1,startingAt:!1,noStartingAt:!1,hasExternalLink:!1,hasHashtags:!1,hasMentions:!1,hasPoll:!1,hasSummary:!1,isSensitive:!1,visibilityPublic:!0,visibilityUnlisted:!0,visibilityFollowers:!0,visibilityMentioned:!0,typeOriginal:!0,typeBoost:!0,attachmentAny:!1,attachmentImage:!1,attachmentVideo:!1,attachmentSound:!1,attachmentNoAltText:!1,attachmentWithAltText:!1},this.filtersActive=!1,this.activeFilters={isEdited:!1,isDuplicate:!1,hasExternalLink:!1,hasPoll:!1,hasSummary:!1,isSensitive:!1,visibilityPublic:!1,visibilityUnlisted:!1,visibilityFollowers:!1,visibilityMentioned:!1,typeOriginal:!1,typeBoost:!1,attachmentAny:!1,attachmentImage:!1,attachmentVideo:!1,attachmentSound:!1,attachmentNoAltText:!1,attachmentWithAltText:!1},this.tagsFilters={hashtags:"",mentions:"",boostsAuthors:""}},setFilter(t){this.checkPagingValue(),scrollTootsToTop(),pagingUpdated(),JSON.stringify(this.filters)===JSON.stringify(this.filtersDefault)?this.filtersActive=!1:this.filtersActive=!0,this.filters.startingAt&&this.filters.noStartingAt&&("startingAt"===t&&(this.filters.noStartingAt=!1),"noStartingAt"===t&&(this.filters.startingAt=!1));const e=this;setTimeout((()=>{e.checkPagingValue()}),50)},filterByTag(t,e,i){e&&(e===this.filters[t]?this.filters[t]="":this.filters[t]=e),"fullText"==t&&(""===this.filters[t]?(this.filters.typeBoost=!0,this.filters.typeOriginal=!0):(this.filters.typeBoost=!0,this.filters.typeOriginal=!1)),this.setFilter(),setTimeout((()=>{document.getElementById(i).focus()}),100)},resetFilters(t){this.filters=JSON.parse(JSON.stringify(this.filtersDefault)),t&&(this.currentPage=1,this.filtersActive=!1,scrollTootsToTop(),pagingUpdated())},get filteredToots(){const t=this.filters,e=this.filtersActive;return this.toots.filter((i=>{if(!e)return!0;if(t.fullText){let e=!1;const s=t.fullText.toLowerCase();if(i._marl.textContent&&i._marl.textContent&&i._marl.textContent.indexOf(s)>=0&&(e=!0),i._marl.hasAttachments&&i.object.attachment.forEach((t=>{const i=t.name;i&&i.indexOf(s)>=0&&(e=!0)})),i._marl.summary&&i._marl.summary.indexOf(s)>=0&&(e=!0),i._marl.pollType){i.object[i._marl.pollType].filter((t=>t.name.toLowerCase().indexOf(s)>=0)).length&&(e=!0)}if(!e)return e}if(t.hashtagText){if("object"!=typeof i.object||null===i.object||!i.object.tag)return!1;{const e=t.hashtagText.toLowerCase();if(!i.object.tag.some((t=>"Hashtag"===t.type&&t.name.toLowerCase().indexOf(e)>-1)))return!1}}if(t.mentionText){if("object"!=typeof i.object||null===i.object||!i.object.tag)return!1;{const e=t.mentionText.toLowerCase();if(!i.object.tag.some((t=>"Mention"===t.type&&t.name.toLowerCase().indexOf(e)>-1)))return!1}}if(t.summary){if(!i._marl.summary)return!1;{const e=t.summary.toLowerCase();if(-1===i._marl.summary.indexOf(e))return!1}}if(t.isEdited&&("object"!=typeof i.object||null===i.object||!i.object.updated))return!1;if(t.isDuplicate&&!i._marl.duplicate)return!1;if(t.startingAt&&(!i._marl.textContent||0!==i._marl.textContent.indexOf("@")))return!1;if(t.noStartingAt&&(!i._marl.textContent||0===i._marl.textContent.indexOf("@")))return!1;if(t.hasExternalLink&&(!i._marl.externalLinks||!i._marl.externalLinks.length))return!1;if(t.hasHashtags){if("object"!=typeof i.object||null===i.object||!i.object.tag)return!1;if(!i.object.tag.some((t=>"Hashtag"===t.type)))return!1}if(t.hasMentions){if("object"!=typeof i.object||null===i.object||!i.object.tag)return!1;if(!i.object.tag.some((t=>"Mention"===t.type)))return!1}if(t.hasPoll){if("object"!=typeof i.object||null===i.object||!i.object.type)return!1;if("Question"!==i.object.type)return!1}if(t.hasSummary){if("object"!=typeof i.object||null===i.object)return!1;if(!i.object.summary)return!1}if(t.isSensitive){if("object"!=typeof i.object||null===i.object)return!1;if(!i.object.sensitive)return!1}if(t.externalLink){let e=!1;if(i._marl.externalLinks&&i._marl.externalLinks.length){const s=t.externalLink.toLowerCase();e=i._marl.externalLinks.some((t=>t.href.indexOf(s)>-1||t.text.indexOf(s)>-1))}if(!e)return!1}if(!t.visibilityPublic&&"public"===i._marl.visibility[0])return!1;if(!t.visibilityUnlisted&&"unlisted"===i._marl.visibility[0])return!1;if(!t.visibilityFollowers&&"followers"===i._marl.visibility[0])return!1;if(!t.visibilityMentioned&&"mentioned"===i._marl.visibility[0])return!1;if(!t.typeOriginal&&"Create"===i.type)return!1;if(!t.typeBoost&&"Announce"===i.type)return!1;if(t.attachmentAny&&!i._marl.hasAttachments)return!1;if(t.attachmentImage){if(!i._marl.hasAttachments)return!1;if(!i.object.attachment.some((t=>attachmentIsImage(t))))return!1}if(t.attachmentVideo){if(!i._marl.hasAttachments)return!1;if(!i.object.attachment.some((t=>attachmentIsVideo(t))))return!1}if(t.attachmentSound){if(!i._marl.hasAttachments)return!1;if(!i.object.attachment.some((t=>attachmentIsSound(t))))return!1}if(t.attachmentNoAltText){if(!i._marl.hasAttachments)return!1;if(!i.object.attachment.some((t=>null===t.name)))return!1}if(t.attachmentWithAltText){if(!i._marl.hasAttachments)return!1;if(!i.object.attachment.some((t=>t.name)))return!1}for(const e in this.languages)if(t.hasOwnProperty("lang_"+e)&&!1===t["lang_"+e]&&(i._marl.langs.includes(e)||0===i._marl.langs.length))return!1;for(const e of this.sources){const s=e.id;if(t.hasOwnProperty("actor_"+s)&&!1===t["actor_"+s]&&i._marl.source===s)return!1}return!0}))},get listHashtags(){return this.listTags("Hashtag")},get listMentions(){return this.listTags("Mention")},listTags(t){let e="";switch(t){case"Mention":e="mentions";break;case"Hashtag":e="hashtags"}let i=this.filteredToots.reduce(((i,s)=>{if(tootHasTags(s))for(const n in s.object.tag){const a=s.object.tag[n];a.type&&a.type===t&&a.name&&a.name.toLowerCase().indexOf(this.tagsFilters[e].toLowerCase())>=0&&(i.some((t=>t.name===a.name))?i.map((t=>{t.name===a.name&&t.nb++})):i.push({name:a.name,href:a.href,nb:1}))}return i}),[]);return i.sort(((t,e)=>t.nb===e.nb?t.name.localeCompare(e.name):e.nb-t.nb)),i},get listBoostsAuthors(){let t=this.boostsAuthors.reduce(((t,e)=>(e.name.toLowerCase().indexOf(this.tagsFilters.boostsAuthors.toLowerCase())>=0&&t.push(e),t)),[]);return t.sort(((t,e)=>{if(t.nb===e.nb){let i=0===t.name.indexOf("? "),s=0===e.name.indexOf("? ");return i&&s?t.name.localeCompare(e.name):i?1:s?-1:t.name.localeCompare(e.name)}return t.nb===e.nb?t.name.localeCompare(e.name):e.nb-t.nb})),t},get sortedLanguages(){let t=[];for(const e in this.languages)t.push([e,this.languages[e]]);return t.sort(((t,e)=>"undefined"===t[0]?1:"undefined"===e[0]?-1:t[1]===e[1]?t[0].localeCompare(e[0]):e[1]-t[1])),t},get appReady(){return!(this.loading||!this.sources.length)},get totalPages(){return Math.ceil(this.filteredToots.length/Alpine.store("ui").pageSize)},get pagedToots(){const t=Alpine.store("ui").pageSize;return this.filteredToots?this.filteredToots.filter(((e,i)=>{let s=(this.currentPage-1)*t,n=this.currentPage*t;if(i>=s&&i<n)return!0})):[]},sortToots(){const t=Alpine.store("ui").sortAsc;this.toots.sort(((e,i)=>t?e.published.localeCompare(i.published):i.published.localeCompare(e.published))),scrollTootsToTop(),pagingUpdated()},checkPagingValue(){this.currentPage<1?this.currentPage=1:this.currentPage>this.totalPages&&(this.currentPage=this.totalPages)},nextPage(t){this.currentPage*Alpine.store("ui").pageSize<this.filteredToots.length&&(this.currentPage++,scrollTootsToTop(t),pagingUpdated())},prevPage(t){this.currentPage>1&&(this.currentPage--,scrollTootsToTop(t),pagingUpdated())},firstPage(t){this.currentPage=1,scrollTootsToTop(t),pagingUpdated()},lastPage(t){this.currentPage=this.totalPages,scrollTootsToTop(t),pagingUpdated()}},lightboxStore={resetState(){this.show=!1,this.data=[],this.source=0,this.index=0,this.origin=""},open(t,e,i){this.data=t.object.attachment,this.source=t._marl.source,this.show=!0,this.index=e,this.origin=i,document.getElementById("main-section-inner").setAttribute("inert",!0),setTimeout((()=>{document.getElementById("lightbox").focus()}),50)},openProfileImg(t,e,i){let s="";localMode()&&(s=Alpine.store("files").sources[i][t].type);const n={object:{attachment:[{name:t,url:t,mediaType:s}]},_marl:{source:i}};this.open(n,0,e)},close(){const t=this.origin;this.data=[],this.index=0,this.show=!1,this.origin="",document.getElementById("main-section-inner").removeAttribute("inert"),document.getElementById(t).focus()},showNext(){this.index++,this.index>=this.data.length&&(this.index=0),attachmentIsImage(this.data[this.index])||this.showNext()},showPrev(){this.index--,this.index<0&&(this.index=this.data.length-1),attachmentIsImage(this.data[this.index])||this.showPrev()}},uiStore={log:[],resetState(){this.pagingOptionsVisible=!1,this.activePanel="",this.actorPanel=0,this.sortAsc=!0,this.pageSize=10,this.mobileLayout=!1,this.lang="en",this.appLangs=appLangs??{en:"English"},this.theme="light",this.errorInLog=!1,this.log=this.log??[],this.combinePanels=!1,this.defaultPanel="auto",this.simplifyPostsDisplay=!1,loadPref("lang"),loadPref("theme"),loadPref("sortAsc"),loadPref("pageSize"),loadPref("combinePanels"),loadPref("activePanel"),loadPref("defaultPanel"),loadPref("simplifyPostsDisplay")},logMsg(t,e){let i={msg:t,type:e=e??"info",time:(new Date).toLocaleTimeString(Alpine.store("ui").lang,{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})};this.log.unshift(i),"error"===e&&(this.errorInLog=!0)},toggleTheme(){this.theme="light"===this.theme?"dark":"light",savePref("theme",this.theme),setTheme(this.theme)},setOption(t){const e=this[t];savePref(t,e),"combinePanels"===t&&this.checkMobileLayout(),"sortAsc"===t&&Alpine.store("files").sortToots(),"pageSize"===t&&Alpine.store("files").checkPagingValue()},togglePagingOptions(){this.pagingOptionsVisible=!this.pagingOptionsVisible,this.pagingOptionsVisible&&setTimeout((()=>{document.getElementById("paging-options").focus()}),100)},get pagingOptionsClass(){return this.pagingOptionsVisible?"open":""},openActorPanel(t){this.actorPanel=t,setTimeout((()=>{document.getElementById("actorpanel-"+t).scrollTop=0}),50)},switchActorPanel(t){let e=this.actorPanel;"up"===t?(e++,e>=Alpine.store("files").sources.length&&(e=0)):(e--,e<0&&(e=Alpine.store("files").sources.length-1)),this.actorPanel=e,document.getElementById("actortab-"+e).focus()},panelClose(){if(this.combinePanels)return;const t=this.activePanel;this.activePanel="",this.setInert(),"tools"!==t||this.mobileLayout?document.querySelector("#main-section-inner .mobile-menu .menu-"+t).focus():document.getElementById("header-open-tools").focus()},panelOpen(t,e){this.activePanel=t,this.resetPanels(),this.setInert(),e&&setTimeout((()=>{document.getElementById("panel-"+t).focus()}),100)},panelToggle(t){switch(t){case"actor":case"filters":case"tags":case"tools":this.activePanel===t?this.combinePanels||this.panelClose():(this.panelOpen(t,!0),savePref("activePanel",t))}},resetPanels(){const t=this.activePanel;if(document.querySelectorAll(`#panel-${t} details[open]`).forEach((t=>{t.removeAttribute("open")})),"actor"===t){const t="actorpanel-"+this.actorPanel;setTimeout((()=>{document.getElementById(t).scrollTop=0}),250)}else setTimeout((()=>{document.getElementById("panel-"+t).scrollTop=0}),250)},checkMobileLayout(){const t=document.getElementById("mobile-menu"),e="none"!==window.getComputedStyle(t,null).display;this.mobileLayout=!!e,this.setInert()},setInertMain(){document.querySelectorAll("#main-section-inner > *:not(.mobile-menu, .panel-backdrop, #panel-"+this.activePanel).forEach((t=>{t.setAttribute("inert",!0)}))},setInertPanels(){this.combinePanels||document.querySelectorAll("#panel-actor, #panel-filters, #panel-tags, #panel-tools").forEach((t=>{t.setAttribute("inert",!0)}))},setInertTools(){document.querySelectorAll("#panel-tools").forEach((t=>{t.setAttribute("inert",!0)}))},setInert(){document.querySelectorAll("#main-section-inner > *").forEach((t=>{t.removeAttribute("inert")})),this.combinePanels?this.setInertPanels():this.mobileLayout?this.activePanel?this.setInertMain():this.setInertPanels():"tools"===this.activePanel?this.setInertMain():this.setInertTools()},get appClasses(){let t=[];return this.combinePanels&&t.push("combine-panels"),this.simplifyPostsDisplay&&t.push("simplify-posts-display"),t},get appInsideClasses(){let t=[];return this.activePanel?t.push("menu-open menu-open-"+this.activePanel):t.push("menu-closed"),t}};