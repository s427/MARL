function customPrefsAvailable(){return"undefined"!=typeof customPrefs&&"object"==typeof customPrefs&&!Array.isArray(customPrefs)&&null!==customPrefs}function customPrefAvailable(e){return!!(customPrefsAvailable()&&e&&customPrefs[e])}function loadCustomPrefs(){if(customPrefsAvailable()){marlConsole(`Loading custom preferences. <b>${JSON.stringify(customPrefs)}</b>`);for(const e in customPrefs)if(Object.prototype.hasOwnProperty.call(customPrefs,e)){const t=customPrefs[e];Alpine.store("ui").changeDefault(e,t)}}}function resetStores(){Alpine.store("files").resetState(),Alpine.store("lightbox").resetState(),Alpine.store("ui").resetState()}function zipFileAlreadyLoaded(e){if(Alpine.store("files").sources.some((t=>t.fileInfos.name===e.name&&t.fileInfos.size===e.size&&t.fileInfos.lastModified===e.lastModified))){const t=`File already loaded: <b>${e.name}</b>`;return console.warn(t),marlConsole(t,"warn"),!0}return!1}function serverMode(){return Alpine.store("files").serverMode}function localMode(){return!Alpine.store("files").serverMode}function checkMobileLayout(){const e=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);Alpine.store("ui").mobileLayout=e<1200}function mobileLayout(){return Alpine.store("ui").mobileLayout}function desktopLayout(){return!Alpine.store("ui").mobileLayout}function combinedPanelsMode(){return Alpine.store("ui").combinePanels&&desktopLayout()}function appReady(){return Alpine.store("files").appReady}function marlBasePath(){let e=Alpine.store("files").marlBasePath;return""===e&&(e=location.href,e.indexOf("index.html")>-1&&(e=e.slice(0,e.indexOf("index.html"))),"/"!==e.slice(-1)&&(e+="/"),Alpine.store("files").marlBasePath=e),e}function savePref(e,t){Alpine.store("userPrefs").save(e,t)}function loadPref(e){Alpine.store("userPrefs").load(e)}function preprocessToots(e,t){let o={langs:[],date:"",time:"",source:t,replies:[],inReplyTo:null};const i=new Date(e.published);o.date=+i.toISOString().slice(0,10).replace(/-/g,""),(!Alpine.store("files").date.first||i<Alpine.store("files").date.first)&&(Alpine.store("files").date.first=i),(!Alpine.store("files").date.last||i>Alpine.store("files").date.last)&&(Alpine.store("files").date.last=i);let s=""+i.getHours();s<10&&(s="0"+s);let n=""+i.getMinutes();if(n<10&&(n="0"+n),o.time=+(s+n),Alpine.store("files").toc.includes(e.id)){const t=Alpine.store("files").toots.filter((t=>t.id===e.id));let i=!1;const s=JSON.stringify(e);if(t.forEach((e=>{let t=JSON.parse(JSON.stringify(e));delete t._marl;const n=JSON.stringify(t);s===n?i=!0:(e._marl.duplicate=!0,o.duplicate=!0,Alpine.store("files").activeFilters.isDuplicate=!0)})),i)return!1}else Alpine.store("files").toc.push(e.id);if("Announce"===e.type&&(Alpine.store("files").activeFilters.typeBoost=!0),"Create"===e.type)if(Alpine.store("files").activeFilters.typeOriginal=!0,"object"==typeof e.object&&null!==e.object&&e.object.contentMap){let t=[];for(let o in e.object.contentMap)t.push(o);o.langs=t}else o.langs=["undefined"];if("object"==typeof e.object&&null!==e.object){if(e.object.content){const t=e.object.content.toLowerCase();o.textContent=stripHTML(t),o.externalLinks=extractExternalLinks(t),o.externalLinks.length&&(Alpine.store("files").activeFilters.hasExternalLink=!0)}if(e.object.likes&&e.object.likes.totalItems>0&&(Alpine.store("files").activeFilters.hasLikes=!0),e.object.shares&&e.object.shares.totalItems>0&&(Alpine.store("files").activeFilters.hasShares=!0),e.object.sensitive&&(Alpine.store("files").activeFilters.isSensitive=!0),e.object.updated&&(Alpine.store("files").activeFilters.isEdited=!0),e.object.summary&&(o.summary=e.object.summary.toLowerCase(),Alpine.store("files").activeFilters.hasSummary=!0),e.object.attachment&&e.object.attachment.length){o.hasAttachments=!0,Alpine.store("files").activeFilters.attachmentNoAltText=!0,Alpine.store("files").activeFilters.attachmentWithAltText=!0;for(let t=0;t<e.object.attachment.length;t++){let o=e.object.attachment[t],i=o.url;const s=i.indexOf("media_attachments/");s>0&&(e.object.attachment[t].url0=i,e.object.attachment[t].url=i.slice(s)),attachmentIsImage(o)&&(Alpine.store("files").activeFilters.attachmentImage=!0),attachmentIsVideo(o)&&(Alpine.store("files").activeFilters.attachmentVideo=!0),attachmentIsSound(o)&&(Alpine.store("files").activeFilters.attachmentSound=!0)}}if(e.object.inReplyTo&&(o.inReplyTo=e.object.inReplyTo),tootHasTags(e))for(let t=0;t<e.object.tag.length;t++){const o=e.object.tag[t];if("Mention"===o.type&&1===(o.name.match(/@/g)||[]).length){const i=o.href.split("/");i[2]&&(e.object.tag[t].name+="@"+i[2])}}if("Question"===e.object.type){Alpine.store("files").activeFilters.hasPoll=!0,e.object.oneOf?o.pollType="oneOf":e.object.anyOf&&(o.pollType="anyOf"),o.totalVotes=0;for(const t of e.object[o.pollType])o.totalVotes+=t.replies.totalItems}}else e.object&&(o.textContent=e.object.toLowerCase());switch(o.visibility=tootVisibility(e),o.visibility[0]){case"public":Alpine.store("files").activeFilters.visibilityPublic=!0;break;case"unlisted":Alpine.store("files").activeFilters.visibilityUnlisted=!0;break;case"followers":Alpine.store("files").activeFilters.visibilityFollowers=!0;break;case"mentioned":Alpine.store("files").activeFilters.visibilityMentioned=!0}const l=e.id.split("/");return o.id=l[l.length-2],e._marl=o,e}function buildTootsInfos(){let e={},t=[],o=!1;const i=Alpine.store("files").toots;if(i.length>0){let n=i.reduce(((e,t)=>{for(let o in t._marl.langs){const i=t._marl.langs[o];e.langs[i]?e.langs[i]++:e.langs[i]=1}if("Announce"===t.type)if("object"==typeof t.object&&null!==t.object);else if(t.object){const o=t.object.split("/");let i,s,n;o.length>2&&(n=o[2],"https:"===o[0]&&"users"===o[3]&&"statuses"===o[5]?(i=o[4],s=`https://${o[2]}/users/${o[4]}/`):(i=`? ${o[2]}`,s=`https://${o[2]}/`),e.boosts[i]?e.boosts[i].nb++:e.boosts[i]={nb:1,name:i,url:s,domain:n})}return"object"==typeof t.object&&null!==t.object&&t.object.inReplyTo&&(e.replies[t.object.inReplyTo]||(e.replies[t.object.inReplyTo]=[]),e.replies[t.object.inReplyTo].push(t.object.id),o=!0),e}),{langs:{},boosts:{},replies:{}});if(e=n.langs,o){Alpine.store("files").activeFilters.isInConversation=!0;for(let e=0;e<i.length;e++){const t=i[e];if("object"==typeof t.object&&null!==t.object&&t.object.id&&n.replies[t.object.id]&&(Alpine.store("files").toots[e]._marl.replies=n.replies[t.object.id]),t._marl.inReplyTo){const o=t._marl.inReplyTo,s=i.filter((e=>e.object.id===o));0===s.length&&(Alpine.store("files").toots[e]._marl.inReplyTo=null)}}}for(var s in t=[],n.boosts)t.push(n.boosts[s])}Alpine.store("files").languages=e,Alpine.store("files").boostsAuthors=t}function buildDynamicFilters(){for(const e in Alpine.store("files").languages)Alpine.store("files").filtersDefault["lang_"+e]=!0;for(const e of Alpine.store("files").sources)Alpine.store("files").filtersDefault["actor_"+e.id]=!0;[Alpine.store("files").activeFilters.attachmentImage,Alpine.store("files").activeFilters.attachmentVideo,Alpine.store("files").activeFilters.attachmentSound].filter(Boolean).length>1&&(Alpine.store("files").activeFilters.attachmentAny=!0),Alpine.store("files").resetFilters(!1)}function buildLikesBookmarks(){const e=["likes","bookmarks"];for(const t of Alpine.store("files").sources)for(const o of e)if(t[o].data.length){const e=t[o].data;let i=[];for(let t=0;t<e.length;t++){const o=e[t];i.push({url:o,inArchive:Alpine.store("files").toots.some((e=>0===e.id.indexOf(o)))})}Alpine.store("files").sources[t.id][o].data=i}}function checkAppReady(e){e&&(document.getElementById("main-section").focus(),Alpine.store("ui").setInert(),Alpine.store("files").sortToots())}function cleanUpRaw(){if(!serverMode())for(let e=0;e<Alpine.store("files").sources.length;e++){const t=Alpine.store("files").sources[e]._raw;if(t.cleanedUp)continue;const o=Alpine.store("files").sources[e].actor;o.image&&o.image.url&&delete t[o.image.url],o.icon&&o.icon.url&&delete t[o.icon.url],delete t["actor.json"],delete t["outbox.json"],delete t["likes.json"],delete t["bookmarks.json"],t.cleanedUp=!0,Alpine.store("files").sources[e]._raw=t}}function setHueForSources(){const e=Alpine.store("files").sources.length,t=Math.round(360*Math.random()),o=Math.round(360/e);for(let i=0;i<e;i++)Alpine.store("files").sources[i].hue=t+o*i}function loadAttachedMedia(e,t){if(!serverMode()&&(attachmentIsImage(e)||attachmentIsVideo(e)||attachmentIsSound(e))){const o=Alpine.store("files").sources[t]._raw,i=Alpine.store("files").sources[t].fileInfos.archiveRoot;let s=e.url;if(!o[i+s])return void(Alpine.store("files").sources[t][e.url]={type:e.mediaType,content:null});o[i+s].async("base64").then((o=>{Alpine.store("files").sources[t][e.url]={type:e.mediaType,content:o}}))}}function pagingUpdated(){document.querySelectorAll("#toots details[open]").forEach((e=>{e.removeAttribute("open")}))}function scrollTootsToTop(e){setTimeout((()=>{document.getElementById("toots").scrollTop=0,e&&document.getElementById(e).focus()}),50)}function contentType(e){let t="";switch(e){case"Create":t="Post";break;case"Announce":t="Boost"}return t}function tootVisibility(e){return e.to.includes("https://www.w3.org/ns/activitystreams#Public")?["public",AlpineI18n.t("filters.visibilityPublic")]:e.to.some((e=>e.indexOf("/followers")>-1))&&!e.to.includes("https://www.w3.org/ns/activitystreams#Public")&&e.cc.includes("https://www.w3.org/ns/activitystreams#Public")?["unlisted",AlpineI18n.t("filters.visibilityUnlisted")]:!e.to.some((e=>e.indexOf("/followers")>-1))||e.to.includes("https://www.w3.org/ns/activitystreams#Public")||e.cc.includes("https://www.w3.org/ns/activitystreams#Public")?e.to.some((e=>e.indexOf("/followers")>-1))||e.to.includes("https://www.w3.org/ns/activitystreams#Public")||e.cc.includes("https://www.w3.org/ns/activitystreams#Public")?void 0:["mentioned",AlpineI18n.t("filters.visibilityMentioned")]:["followers",AlpineI18n.t("filters.visibilityFollowers")]}function tootHasTags(e){return"object"==typeof e.object&&null!==e.object&&e.object.tag&&e.object.tag.length}function formatJson(e){let t=e;return!t._marl||customPrefAvailable("showMarlJson")&&customPrefs.showMarlJson||(t=JSON.parse(JSON.stringify(e)),delete t._marl),JSON.stringify(t,null,4)}function formatAuthor(e,t){return t?e.split("/").pop():`<a href="${e}" target="_blank">${e.split("/").pop()}</a>`}function formatDateTime(e){return new Date(e).toLocaleDateString(Alpine.store("ui").lang,{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit"})}function formatFileDateTime(e){return new Date(e).toLocaleDateString(Alpine.store("ui").lang,{year:"numeric",month:"2-digit",day:"2-digit",hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"})}function formatFileSize(e){var t=0==e?0:Math.floor(Math.log(e)/Math.log(1024));return 1*+(e/Math.pow(1024,t)).toFixed(2)+" "+["B","kB","MB","GB","TB"][t]}function formatDate(e){return new Date(e).toLocaleDateString(Alpine.store("ui").lang,{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function formatNumber(e){return void 0===e?"":e.toLocaleString()}function formatLikesBookmarks(e){const t=e.split("/");t.splice(0,2);let o=`<span class="url-instance">${t[0]}</span>`;return"users"===t[1]&&"statuses"===t[3]?o+=`<span class="url-actor">${t[2]}</span><span class="url-post-id">${t[4]}</span>`:(t.splice(0,1),o+=`<span class="url-post-id">${t.join("/")}</span>`),o}function stripHTML(e){return(new DOMParser).parseFromString(e,"text/html").body.textContent||""}function extractExternalLinks(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelectorAll("a[href]:not(.mention)");let o=[];return t.forEach((e=>{o.push({href:e.href,text:e.textContent})})),o}function attachmentIsImage(e){return"image/jpeg"===e.mediaType||"image/png"===e.mediaType}function attachmentIsVideo(e){return"video/mp4"===e.mediaType}function attachmentIsSound(e){return"audio/mpeg"===e.mediaType}function attachmentWrapperClass(e){let t=[];return attachmentIsImage(e)?t.push("att-img"):attachmentIsSound(e)?t.push("att-sound"):attachmentIsVideo(e)&&t.push("att-video"),e.name||t.push("no-alt-text"),t}function pollQuestionPc(e,t){const o=e.object[e._marl.pollType];return pc=o[t].replies.totalItems/e.object.votersCount*100,pc||0}function isFilterActive(e){return Alpine.store("files").filters[e]!==Alpine.store("files").filtersDefault[e]}function startOver(){const e=AlpineI18n.t("tools.startOverConfirm");confirm(e)&&location.reload()}function detectLangFromBrowser(){if(customPrefAvailable("lang")&&validLang(customPrefs.lang))return customPrefs.lang;const e=navigator.languages;if(e&&e.length)for(let t=0;t<e.length;t++){let o=e[t].split("-")[0];if(validLang(o)){return marlConsole(`Setting language based on browser preference: <b>'${o}' (${Alpine.store("ui").appLangs[o]})</b>`,"info"),o}}return!1}function setLang(){const e=Alpine.store("ui").lang;AlpineI18n.locale=e,savePref("lang",e),document.getElementsByTagName("html")[0].setAttribute("lang",e);marlConsole(`App language set to <b>'${e}' (${Alpine.store("ui").appLangs[e]})</b>`)}function detectThemePreference(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function setTheme(e){e||(e=detectThemePreference()),document.getElementsByTagName("html")[0].setAttribute("class",e),"dark"===e?document.querySelector('meta[name="color-scheme"]').setAttribute("content","dark"):document.querySelector('meta[name="color-scheme"]').setAttribute("content","light")}function marlConsole(e,t="info"){Alpine.store("ui").logMsg(e,t)}function validDefaultPanel(e){return["actor","filters","tags","tools","none"].includes(e)}function validTheme(e){return["light","dark"].includes(e)}function validLang(e){return!!appLangs[e]}function postsScrolled(){Alpine.store("ui").checkPostsScrolling(),setTimeout((()=>{Alpine.store("ui").checkPostsScrolling()}),200)}function searchFullText(e){Alpine.store("files").resetFilters(!0),Alpine.store("files").filters.fullText=e,Alpine.store("files").setFilter()}function getVideoProperties(e){return new Promise((t=>{const o=()=>{const o=e.duration<=10;let i=!1;e.audioTracks?i=e.audioTracks.length>0:void 0!==e.webkitAudioDecodedByteCount?i=e.webkitAudioDecodedByteCount>0:void 0!==e.mozHasAudio&&(i=e.mozHasAudio),t({duration:e.duration,isShort:o,hasAudio:i,isGifLike:o&&!i})};e.readyState>=1?o():e.addEventListener("loadedmetadata",o,{once:!0})}))}function checkGif(e){const t=document.getElementById(e);getVideoProperties(t).then((e=>{e.isGifLike&&(Alpine.store("ui").loopGifs?(t.loop=!0,t.removeAttribute("controls"),t.play()):(t.removeAttribute("loop"),t.controls=!0,t.pause()));const o=e=>{e.setAttribute("controls","controls")};t.removeEventListener("mouseenter",o(t)).addEventListener("mouseenter",o(t)),t.removeEventListener("touchstart",o(t)).addEventListener("touchstart",o(t))}))}function checkGifsOnPage(){document.querySelectorAll("#toots .toot-attachments video").forEach((e=>{checkGif(e.id)}))}const drag={el:null,init(e){this.dropArea=document.getElementById(e),["dragenter","dragover","dragleave","drop"].forEach((e=>{this.dropArea.addEventListener(e,(e=>this.preventDragDefaults(e)),!1)})),["dragenter","dragover"].forEach((e=>{this.dropArea.addEventListener(e,(()=>this.highlightDrag()),!1)})),["dragleave","drop"].forEach((e=>{this.dropArea.addEventListener(e,(()=>this.unhighlightDrag()),!1)})),this.dropArea.addEventListener("drop",(e=>this.handleDrop(e)),!1)},preventDragDefaults(e){e.preventDefault(),e.stopPropagation()},highlightDrag(){this.dropArea.classList.add("highlight-drag")},unhighlightDrag(){this.dropArea.classList.remove("highlight-drag")},handleDrop(e){const t=e.dataTransfer.files;loadZipFiles(t)}};